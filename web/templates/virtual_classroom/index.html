<!DOCTYPE html>
{% load static %}

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
          content="Real-time virtual classroom for interactive learning and collaboration." />
    <!-- djlint:off H026 -->
    <meta name="keywords"
          content="virtual classroom, online learning, live class, collaboration" />
    <!-- djlint:on H026 -->
    <meta name="classroom-id" content="{{ classroom.id }}" />
    <meta name="current-user" content="{{ request.user.username }}" />
    <title>Virtual Classroom</title>
    <script src="https://unpkg.com/lucide@0.263.1"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>
  </head>
  <body class="min-h-screen bg-gray-100" x-data="classroomApp()">
    <header class="bg-white shadow-md p-4">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">{{ classroom.name }}</h1>
        <div class="flex items-center space-x-4">
          <!-- Back to Course Button -->
          {% if classroom.course %}
            <a href="{% url 'course_detail' slug=classroom.course.slug %}"
               class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors flex items-center gap-2">
              <i data-lucide="arrow-left"></i>
              <span>Back to Course</span>
            </a>
          {% endif %}
          <!-- Student List Button -->
          <button id="toggleStudentList"
                  class="px-4 py-2 bg-teal-300 text-white rounded-md hover:bg-teal-400 transition-colors flex items-center gap-2">
            <i data-lucide="users"></i>
            <span x-text="`Students (${Object.keys(participants).length})`">Students</span>
          </button>
          <button id="toggleControls"
                  class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center gap-2">
            <i data-lucide="layout"></i>
            <span>Show Controls</span>
          </button>
        </div>
      </div>
    </header>
    <!-- Student List Sidebar -->
    <div id="studentList"
         class="fixed right-0 top-0 h-full w-80 bg-white shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-50">
      <div class="p-4 border-b">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-semibold text-gray-800">Active Students</h2>
          <button id="closeStudentList" class="text-gray-500 hover:text-gray-700">
            <i data-lucide="x"></i>
          </button>
        </div>
      </div>
      <div class="p-4">
        <div id="studentsList" class="space-y-3">
          <!-- Display participants dynamically with Alpine.js -->
          <template x-for="[username, participant] in Object.entries(participants)"
                    :key="username">
            <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
              <div class="flex items-center space-x-3">
                <div x-show="participant.avatar_url">
                  <img :src="participant.avatar_url"
                       :alt="participant.full_name"
                       width="32"
                       height="32"
                       class="w-8 h-8 rounded-full" />
                </div>
                <div x-show="!participant.avatar_url"
                     class="w-8 h-8 rounded-full bg-teal-300 flex items-center justify-center text-white text-xs font-bold">
                  <span x-text="(participant.full_name || participant.username || '?').charAt(0).toUpperCase()"></span>
                </div>
                <div>
                  <p class="font-medium text-sm text-gray-800"
                     x-text="participant.full_name"></p>
                  <p class="text-xs text-gray-600"
                     x-text="`Joined ${new Date(participant.joined_at).toLocaleString()}`"></p>
                </div>
              </div>
              <div class="flex items-center space-x-2">
                <span x-show="participant.seat_id"
                      class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"
                      x-text="`Seat ${participant.seat_id}`"></span>
                <span x-show="!participant.seat_id"
                      class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-600">Idle</span>
              </div>
            </div>
          </template>
          <!-- Empty state -->
          <div x-show="Object.keys(participants).length === 0"
               class="text-gray-500 text-center py-8">No other students in the classroom yet.</div>
        </div>
      </div>
    </div>
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
      <!-- Control Panel -->
      <div id="controlPanel"
           class="hidden w-full md:w-1/4 bg-white p-4 overflow-auto shadow-md">
        <h2 class="text-xl font-semibold mb-4">Customize Classroom</h2>
        <!-- Color Settings -->
        <div class="space-y-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Wall Color</label>
            <div class="flex items-center">
              <input type="color"
                     id="wallColor"
                     value="{{ customization.wall_color|default:'#E6E2D7' }}"
                     class="w-10 h-10 rounded cursor-pointer" />
              <span class="ml-2 text-sm" id="wallColorValue">{{ customization.wall_color|default:'#E6E2D7' }}</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Floor Color</label>
            <div class="flex items-center">
              <input type="color"
                     id="floorColor"
                     value="{{ customization.floor_color|default:'#C7B299' }}"
                     class="w-10 h-10 rounded cursor-pointer" />
              <span class="ml-2 text-sm" id="floorColorValue">{{ customization.floor_color|default:'#C7B299' }}</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Desk Color</label>
            <div class="flex items-center">
              <input type="color"
                     id="deskColor"
                     value="{{ customization.desk_color|default:'#8B4513' }}"
                     class="w-10 h-10 rounded cursor-pointer" />
              <span class="ml-2 text-sm" id="deskColorValue">{{ customization.desk_color|default:'#8B4513' }}</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Chair Color</label>
            <div class="flex items-center">
              <input type="color"
                     id="chairColor"
                     value="{{ customization.chair_color|default:'#4B0082' }}"
                     class="w-10 h-10 rounded cursor-pointer" />
              <span class="ml-2 text-sm" id="chairColorValue">{{ customization.chair_color|default:'#4B0082' }}</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Board Color</label>
            <div class="flex items-center">
              <input type="color"
                     id="boardColor"
                     value="{{ customization.board_color|default:'#005C53' }}"
                     class="w-10 h-10 rounded cursor-pointer" />
              <span class="ml-2 text-sm" id="boardColorValue">{{ customization.board_color|default:'#005C53' }}</span>
            </div>
          </div>
        </div>
        <!-- Layout Settings -->
        <div class="space-y-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Number of rows</label>
            <input type="range"
                   id="numRows"
                   min="1"
                   max="10"
                   value="{{ customization.number_of_rows|default:5 }}"
                   class="w-full" />
            <span class="text-sm" id="numRowsValue">{{ customization.number_of_rows|default:5 }}</span>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Desks per Row</label>
            <input type="range"
                   id="desksPerRow"
                   min="1"
                   max="10"
                   value="{{ customization.desks_per_row|default:6 }}"
                   class="w-full" />
            <span class="text-sm" id="desksPerRowValue">{{ customization.desks_per_row|default:6 }}</span>
          </div>
        </div>
        <!-- Toggle Settings -->
        <div class="space-y-3">
          <div class="flex items-center">
            <input type="checkbox"
                   id="hasPlants"
                   {% if customization.has_plants %}checked{% endif %}
                   class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
            <label for="hasPlants" class="ml-2 text-sm text-gray-700">Plants</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox"
                   id="hasWindows"
                   {% if customization.has_windows %}checked{% endif %}
                   class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
            <label for="hasWindows" class="ml-2 text-sm text-gray-700">Windows</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox"
                   id="hasBookshelf"
                   {% if customization.has_bookshelf %}checked{% endif %}
                   class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
            <label for="hasBookshelf" class="ml-2 text-sm text-gray-700">Bookshelf</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox"
                   id="hasClock"
                   {% if customization.has_clock %}checked{% endif %}
                   class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
            <label for="hasClock" class="ml-2 text-sm text-gray-700">Clock</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox"
                   id="hasCarpet"
                   {% if customization.has_carpet %}checked{% endif %}
                   class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
            <label for="hasCarpet" class="ml-2 text-sm text-gray-700">Carpet</label>
          </div>
        </div>
      </div>
      <!-- Classroom Container -->
      <div class="flex-1 p-4">
        <div id="classroomContainer"
             class="w-full h-[calc(100vh-10rem)] relative overflow-hidden rounded-xl shadow-xl bg-slate-800">
          <!-- Classroom elements will be rendered here -->
        </div>
        <!-- Controls Info -->
        <div class="mt-4 bg-white p-3 rounded-md shadow-md">
          <h3 class="text-lg font-semibold mb-2">Controls</h3>
          <div class="flex items-center flex-wrap space-x-6">
            <div class="flex items-center">
              <i data-lucide="move-up" class="mr-1 text-blue-600"></i>
              <i data-lucide="move-down" class="mr-1 text-blue-600"></i>
              <i data-lucide="move-left" class="mr-1 text-blue-600"></i>
              <i data-lucide="move-right" class="mr-1 text-blue-600"></i>
              <span class="text-sm">Move character</span>
            </div>
            <div>
              <span class="text-sm">Customize using the control panel!</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
        // Alpine.js classroom app
        function classroomApp() {
            return {
                debug: false,
                participants: {},
                classroomId: document.querySelector('meta[name="classroom-id"]').content,
                websocket: null,
                reconnectAttempts: 0,
                maxReconnectAttempts: 10,
                baseReconnectDelay: 1000,

                log(...args) {
                    if (this.debug) {
                        console.log(...args);
                    }
                },

                init() {
                    this.log('Initializing Alpine.js classroom app');
                    this.log('Classroom ID:', this.classroomId);
                    this.log('Current participants:', this.participants);
                    this.initWebSocket();
                },

                initWebSocket() {
                    const wsScheme = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsPath = `${wsScheme}//${window.location.host}/ws/classroom/${this.classroomId}/`;

                    this.log('Connecting to WebSocket:', wsPath);
                    this.websocket = new WebSocket(wsPath);

                    this.websocket.onopen = (event) => {
                        this.log('WebSocket connected successfully');
                        this.reconnectAttempts = 0;
                    };

                    this.websocket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.log('WebSocket message received:', data);
                        this.handleWebSocketMessage(data);
                    };

                    this.websocket.onclose = (event) => {
                        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                            console.error('Max reconnection attempts reached');
                            return;
                        }
                        const delay = Math.min(this.baseReconnectDelay * Math.pow(2, this.reconnectAttempts), 30000);
                        this.log(
                            `WebSocket disconnected, reconnecting in ${delay}ms (attempt ${this.reconnectAttempts + 1})`
                        );
                        this.reconnectAttempts++;
                        setTimeout(() => {
                            if (!this.websocket || this.websocket.readyState === WebSocket.CLOSED) {
                                this.initWebSocket();
                            }
                        }, delay);
                    };

                    this.websocket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                },

                handleWebSocketMessage(data) {
                    this.log('=== WebSocket Message Handler Called ===');
                    this.log('Message type:', data.type);
                    this.log('Full message data:', data);

                    switch (data.type) {
                        case 'classroom_presence_update':
                            this.log('=== CLASSROOM PRESENCE UPDATE ===');
                            this.log('Current participants before update:', this.participants);
                            this.log('New presence data:', data.presence);
                            this.participants = data.presence || {};
                            this.log('Participants after update:', this.participants);
                            this.log('Number of participants:', Object.keys(this.participants).length);
                            this.$nextTick(() => {
                                this.log('Calling renderAvatarsOnDesks after presence update');
                                this.renderAvatarsOnDesks();
                            });
                            break;
                        case 'participant_joined':
                            this.log('=== PARTICIPANT JOINED ===');
                            this.log('Participant joined:', data.user.username, 'at seat:', data.seat_id);
                            break;
                        case 'participant_left':
                            this.log('=== PARTICIPANT LEFT ===');
                            this.log('Participant left:', data.user.username);
                            break;
                        case 'seat_updated':
                            this.log('=== SEAT UPDATED ===');
                            this.log('Seat updated:', data.user.username, 'to seat', data.seat_id);
                            this.updateParticipantSeat(data.user.username, data.seat_id);
                            break;
                        case 'seat_left':
                            this.log('=== SEAT LEFT ===');
                            this.log('Seat left:', data.user.username, 'from seat', data.seat_id);
                            this.updateParticipantSeat(data.user.username, null);
                            break;
                        default:
                            this.log('Unknown message type:', data.type);
                    }
                },

                updateParticipantSeat(username, seatId) {
                    if (username === '__proto__' || username === 'constructor' || username === 'prototype') {
                        console.warn('Attempted prototype pollution with username:', username);
                        return;
                    }
                    if (Object.prototype.hasOwnProperty.call(this.participants, username)) {
                        this.participants[username].seat_id = seatId;
                        this.$nextTick(() => {
                            this.renderAvatarsOnDesks();
                        });
                    }
                },

                renderAvatarsOnDesks() {
                    this.log('=== RENDER AVATARS ON DESKS ===');
                    this.log('Current participants to render:', this.participants);
                    this.log('Number of participants:', Object.keys(this.participants).length);

                    // Remove existing avatars
                    const existingAvatars = document.querySelectorAll('.desk-avatar');
                    this.log('Removing', existingAvatars.length, 'existing avatars');
                    existingAvatars.forEach(el => el.remove());

                    // Add avatars for seated participants
                    let rendered = 0;
                    Object.entries(this.participants).forEach(([username, participant]) => {
                        this.log('Processing participant:', username, participant);
                        if (participant.seat_id) {
                            this.log('Rendering avatar for', username, 'at seat', participant.seat_id);
                            this.renderAvatarAtDesk(participant);
                            rendered++;
                        } else {
                            this.log('Participant', username, 'has no seat_id');
                        }
                    });
                    this.log('Total avatars rendered:', rendered);
                },

                renderAvatarAtDesk(participant) {
                    this.log('=== RENDER AVATAR AT DESK ===');
                    this.log('Participant data:', participant);

                    const seatId = participant.seat_id;
                    this.log('Seat ID:', seatId);

                    if (!seatId) {
                        this.log('No seat ID found for participant');
                        return;
                    }

                    // Extract seat number from seat-X format
                    const seatNumber = parseInt(seatId.replace('seat-', ''), 10);
                    this.log('Seat number:', seatNumber);

                    // Map seat number to desk row/col
                    const desksPerRowInput = document.getElementById('desksPerRow');
                    const desksPerRow = desksPerRowInput ? parseInt(desksPerRowInput.value, 10) : 6;
                    const row = Math.ceil(seatNumber / desksPerRow);
                    const col = ((seatNumber - 1) % desksPerRow) + 1;

                    this.log('Mapped to desk row:', row, 'col:', col);

                    const deskElementId = `desk-chair-${row}-${col}`;
                    this.log('Looking for desk element with ID:', deskElementId);

                    const deskElement = document.getElementById(deskElementId);
                    this.log('Found desk element:', deskElement);

                    if (deskElement) {
                        // Remove any existing avatar on this desk
                        const existingAvatar = deskElement.querySelector('.desk-avatar');
                        if (existingAvatar) {
                            this.log('Removing existing avatar from desk');
                            existingAvatar.remove();
                        }

                        const displayName = participant.full_name || participant.username || 'User';

                        // Create avatar element safely
                        const avatar = document.createElement('div');
                        avatar.className = 'desk-avatar absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-8 z-50';

                        const container = document.createElement('div');
                        container.className = 'relative flex flex-col items-center';

                        const avatarCircle = document.createElement('div');
                        avatarCircle.className = 'w-8 h-8 rounded-full bg-gradient-to-r from-teal-400 to-blue-500 flex items-center justify-center text-white text-xs font-bold border-2 border-white shadow-lg';

                        if (participant.avatar_url) {
                            const img = document.createElement('img');
                            img.src = participant.avatar_url;
                            img.alt = displayName;
                            img.className = 'w-full h-full rounded-full object-cover';
                            avatarCircle.appendChild(img);
                        } else {
                            avatarCircle.textContent = displayName.charAt(0).toUpperCase();
                        }

                        const nameLabel = document.createElement('div');
                        nameLabel.className = 'text-xs text-white bg-gray-800 bg-opacity-90 px-2 py-1 rounded mt-1 whitespace-nowrap shadow-md';
                        nameLabel.textContent = displayName;

                        container.appendChild(avatarCircle);
                        container.appendChild(nameLabel);
                        avatar.appendChild(container);

                        this.log('Created avatar element:', avatar);
                        deskElement.appendChild(avatar);
                        this.log('Avatar added to desk element');
                    } else {
                        console.error('Desk element not found with ID:', deskElementId);
                        // Try to list all available desk elements for debugging
                        const allDesks = document.querySelectorAll('[id^="desk-chair-"]');
                        this.log('Available desk elements:', Array.from(allDesks).map(d => d.id));
                    }
                }
            }
        }

        // Student list functionality
        const studentList = document.getElementById('studentList');
        const toggleStudentList = document.getElementById('toggleStudentList');
        const closeStudentList = document.getElementById('closeStudentList');

        toggleStudentList.addEventListener('click', () => {
            studentList.classList.toggle('translate-x-full');
        });

        closeStudentList.addEventListener('click', () => {
            studentList.classList.add('translate-x-full');
        });
    </script>
    <script src="{% static 'js/virtual_classroom.js' %}"></script>
  </body>
</html>
